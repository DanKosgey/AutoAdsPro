import fs from 'fs';
import path from 'path';
import { v4 as uuidv4 } from 'uuid';
import axios from 'axios';

export class LeonardoImageGenerationService {
    private static instance: LeonardoImageGenerationService;
    private readonly apiKey: string;
    private readonly baseUrl = 'https://cloud.leonardo.ai/api/rest/v1';

    private constructor() {
        this.apiKey = process.env.LEONARDO_API || '';
        const tempDir = path.join(process.cwd(), 'temp');
        if (!fs.existsSync(tempDir)) {
            fs.mkdirSync(tempDir);
        }
    }

    public static getInstance(): LeonardoImageGenerationService {
        if (!LeonardoImageGenerationService.instance) {
            LeonardoImageGenerationService.instance = new LeonardoImageGenerationService();
        }
        return LeonardoImageGenerationService.instance;
    }

    /**
     * Generates an image using Leonardo AI
     */
    public async generateImage(prompt: string, retryCount = 1): Promise<string> {
        if (!this.apiKey) {
            throw new Error('LEONARDO_API key is missing in environment variables');
        }

        console.log(`üé® Creating Leonardo AI generation for: "${prompt.substring(0, 100)}..."`);

        try {
            // 1. Initiate Generation
            const initResponse = await axios.post(
                `${this.baseUrl}/generations`,
                {
                    modelId: "b2614463-296c-462a-9586-aafdb8f00e36", // FLUX Dev
                    prompt: prompt.substring(0, 1400),
                    width: 1024,
                    height: 1024,
                    num_images: 1,
                    contrast: 3.5,
                    styleUUID: "111dc692-d470-4eec-b791-3475abac4c46", // Dynamic
                    enhancePrompt: false
                },
                {
                    headers: {
                        'accept': 'application/json',
                        'authorization': `Bearer ${this.apiKey}`,
                        'content-type': 'application/json'
                    }
                }
            );

            const generationId = initResponse.data.sdGenerationJob?.generationId;
            if (!generationId) {
                throw new Error('Failed to get generationId from Leonardo AI');
            }

            console.log(`‚è≥ Generation ID: ${generationId}. Polling for results...`);

            // 2. Poll for Status
            let imageUrl: string | null = null;
            let attempts = 0;
            const maxAttempts = 30; // 30 * 2s = 60s max wait

            while (!imageUrl && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 2000));
                attempts++;

                const statusResponse = await axios.get(
                    `${this.baseUrl}/generations/${generationId}`,
                    {
                        headers: {
                            'accept': 'application/json',
                            'authorization': `Bearer ${this.apiKey}`
                        }
                    }
                );

                const generation = statusResponse.data.generations_by_pk;
                if (generation?.status === 'COMPLETE' && generation.generated_images?.length > 0) {
                    imageUrl = generation.generated_images[0].url;
                } else if (generation?.status === 'FAILED') {
                    throw new Error('Leonardo AI generation failed');
                }

                if (attempts % 5 === 0) {
                    console.log(`...still waiting (${attempts * 2}s)`);
                }
            }

            if (!imageUrl) {
                throw new Error('Timeout waiting for Leonardo AI image generation');
            }

            // 3. Download the image
            console.log(`üì• Image ready! Downloading...`);
            const imageResponse = await axios.get(imageUrl, {
                responseType: 'arraybuffer',
                timeout: 30000
            });

            const fileName = `img_${uuidv4()}.jpg`;
            const filePath = path.join(process.cwd(), 'temp', fileName);
            fs.writeFileSync(filePath, Buffer.from(imageResponse.data));

            console.log(`‚úÖ Image saved to ${filePath}`);
            return filePath;

        } catch (error: any) {
            console.error('‚ùå Leonardo AI Generation Failed:', error.response?.data || error.message);
            throw new Error(`LEONARDO_AI_FAILED: ${error.message}`);
        }
    }

    /**
     * Generate multiple variations (sequential for Leonardo)
     */
    public async generateImageVariations(prompt: string, count: number = 3): Promise<string[]> {
        const images: string[] = [];
        for (let i = 0; i < count; i++) {
            try {
                const path = await this.generateImage(prompt);
                images.push(path);
            } catch (err) {
                console.error(`Error generating variation ${i + 1}:`, err);
            }
        }
        return images;
    }
}

export const googleImageGenerationService = LeonardoImageGenerationService.getInstance();
